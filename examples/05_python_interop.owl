// ===========================================
// OwlLang Example: Python Interoperability
// ===========================================

// ============ Importing Python Modules ============

// Import entire module with alias
from python import numpy as np
from python import pandas as pd
from python import requests
from python import json

// Import specific items
from python.os import getcwd, listdir
from python.os.path import exists, join, dirname
from python.datetime import datetime, timedelta

// Import with type hints for better IDE support
from python import matplotlib.pyplot as plt: {
    figure: (figsize: Tuple[Int, Int]) -> Figure,
    plot: (x: Any, y: Any, label: String) -> Unit,
    show: () -> Unit
}

// ============ NumPy Examples ============

fn numpy_demo() {
    print("=== NumPy Demo ===")
    
    // Create arrays
    let arr = np.array([1, 2, 3, 4, 5])
    let zeros = np.zeros((3, 3))
    let ones = np.ones((2, 4))
    let range_arr = np.arange(0, 10, 2)
    
    print("Array: {arr}")
    print("Zeros:\n{zeros}")
    print("Ones:\n{ones}")
    print("Range: {range_arr}")
    
    // Array operations
    let doubled = arr * 2
    let squared = arr ** 2
    let sum = np.sum(arr)
    let mean = np.mean(arr)
    let std = np.std(arr)
    
    print("\nOperations:")
    print("Doubled: {doubled}")
    print("Squared: {squared}")
    print("Sum: {sum}")
    print("Mean: {mean}")
    print("Std: {std}")
    
    // Matrix operations
    let matrix_a = np.array([[1, 2], [3, 4]])
    let matrix_b = np.array([[5, 6], [7, 8]])
    
    let product = np.dot(matrix_a, matrix_b)
    let transpose = matrix_a.T
    let inverse = np.linalg.inv(matrix_a.astype(np.float64))
    
    print("\nMatrix A:\n{matrix_a}")
    print("Matrix B:\n{matrix_b}")
    print("A Ã— B:\n{product}")
    print("A transposed:\n{transpose}")
    print("A inverse:\n{inverse}")
    
    // Statistical operations
    let data = np.random.randn(1000)
    print("\nRandom data stats:")
    print("Mean: {np.mean(data):.4f}")
    print("Std: {np.std(data):.4f}")
    print("Min: {np.min(data):.4f}")
    print("Max: {np.max(data):.4f}")
}

// ============ Pandas Examples ============

fn pandas_demo() {
    print("\n=== Pandas Demo ===")
    
    // Create DataFrame
    let df = pd.DataFrame({
        "name": ["Alice", "Bob", "Charlie", "Diana", "Eve"],
        "age": [25, 30, 35, 28, 32],
        "city": ["New York", "Los Angeles", "Chicago", "Houston", "Phoenix"],
        "salary": [50000, 60000, 75000, 55000, 65000]
    })
    
    print("DataFrame:\n{df}")
    print("\nShape: {df.shape}")
    print("Columns: {df.columns.tolist()}")
    
    // Filtering
    let adults = df[df["age"] >= 30]
    print("\nPeople 30+:\n{adults}")
    
    // Sorting
    let by_salary = df.sort_values("salary", ascending: false)
    print("\nSorted by salary:\n{by_salary}")
    
    // Aggregation
    print("\nStatistics:")
    print("Average age: {df['age'].mean():.1f}")
    print("Total salary: ${df['salary'].sum():,}")
    print("Max salary: ${df['salary'].max():,}")
    
    // Group by
    let city_stats = df.groupby("city")["salary"].mean()
    print("\nAverage salary by city:\n{city_stats}")
    
    // Adding columns
    let df_with_bonus = df.assign(
        bonus: df["salary"] * 0.1,
        total: df["salary"] * 1.1
    )
    print("\nWith bonus:\n{df_with_bonus}")
    
    // Method chaining (OwlLang pipe-friendly)
    let result = df
        |> _.query("age >= 28")
        |> _.sort_values("salary", ascending: false)
        |> _.head(3)
    
    print("\nTop 3 earners (28+):\n{result}")
}

// ============ Requests Examples ============

fn requests_demo() {
    print("\n=== Requests Demo ===")
    
    // Simple GET request
    let response = requests.get("https://api.github.com/users/python")
    
    print("Status: {response.status_code}")
    print("Content-Type: {response.headers['Content-Type']}")
    
    if response.ok {
        let data = response.json()
        print("User: {data['login']}")
        print("Name: {data['name']}")
        print("Public repos: {data['public_repos']}")
    }
    
    // POST request with JSON
    let payload = {
        "title": "Hello from OwlLang",
        "body": "This is a test post",
        "userId": 1
    }
    
    let post_response = requests.post(
        "https://jsonplaceholder.typicode.com/posts",
        json: payload
    )
    
    print("\nPOST response: {post_response.status_code}")
    print("Created: {post_response.json()}")
    
    // With headers
    let headers = {
        "Authorization": "Bearer token123",
        "Accept": "application/json"
    }
    
    let auth_response = requests.get(
        "https://httpbin.org/headers",
        headers: headers
    )
    print("\nHeaders echoed: {auth_response.json()['headers']}")
}

// ============ Matplotlib Examples ============

fn matplotlib_demo() {
    print("\n=== Matplotlib Demo ===")
    
    // Line plot
    let x = np.linspace(0, 2 * np.pi, 100)
    let y_sin = np.sin(x)
    let y_cos = np.cos(x)
    
    plt.figure(figsize: (10, 6))
    plt.plot(x, y_sin, label: "sin(x)", color: "blue")
    plt.plot(x, y_cos, label: "cos(x)", color: "red")
    plt.xlabel("x")
    plt.ylabel("y")
    plt.title("Trigonometric Functions")
    plt.legend()
    plt.grid(true)
    plt.savefig("trig_plot.png")
    print("Plot saved to trig_plot.png")
    
    // Bar chart
    let categories = ["A", "B", "C", "D", "E"]
    let values = [23, 45, 56, 78, 32]
    
    plt.figure(figsize: (8, 5))
    plt.bar(categories, values, color: "skyblue")
    plt.xlabel("Category")
    plt.ylabel("Value")
    plt.title("Bar Chart Example")
    plt.savefig("bar_chart.png")
    print("Chart saved to bar_chart.png")
}

// ============ JSON Handling ============

fn json_demo() {
    print("\n=== JSON Demo ===")
    
    // Parse JSON
    let json_str = """
    {
        "name": "OwlLang",
        "version": "0.1.0",
        "features": ["python-interop", "type-safety", "immutability"],
        "config": {
            "debug": true,
            "max_threads": 4
        }
    }
    """
    
    let data = json.loads(json_str)
    print("Parsed: {data}")
    print("Name: {data['name']}")
    print("Features: {data['features']}")
    print("Debug mode: {data['config']['debug']}")
    
    // Create JSON
    let owl_config = {
        "language": "OwlLang",
        "compatibility": ["Python 3.9", "Python 3.10", "Python 3.11"],
        "settings": {
            "strict_mode": true,
            "optimization_level": 2
        }
    }
    
    let json_output = json.dumps(owl_config, indent: 2)
    print("\nGenerated JSON:\n{json_output}")
}

// ============ Combining Python Libraries ============

fn data_analysis_pipeline() {
    print("\n=== Data Analysis Pipeline ===")
    
    // Generate sample data
    np.random.seed(42)
    let n = 100
    
    let df = pd.DataFrame({
        "date": pd.date_range(start: "2024-01-01", periods: n, freq: "D"),
        "sales": np.random.randint(100, 1000, n),
        "costs": np.random.randint(50, 500, n),
        "region": np.random.choice(["North", "South", "East", "West"], n)
    })
    
    // Calculate profit
    let df = df.assign(profit: df["sales"] - df["costs"])
    
    print("Sample data:\n{df.head()}")
    
    // Analysis by region
    let regional_summary = df.groupby("region").agg({
        "sales": ["sum", "mean"],
        "profit": ["sum", "mean"]
    }).round(2)
    
    print("\nRegional Summary:\n{regional_summary}")
    
    // Time series analysis
    let weekly = df.set_index("date").resample("W").sum()
    print("\nWeekly totals:\n{weekly.head()}")
    
    // Export results
    regional_summary.to_csv("regional_summary.csv")
    print("\nExported to regional_summary.csv")
}

// ============ Error Handling with Python ============

fn safe_python_call() {
    print("\n=== Error Handling ===")
    
    // Using Result type with Python calls
    fn fetch_safely(url: String) -> Result[Dict, String] {
        try {
            let response = requests.get(url, timeout: 5)
            response.raise_for_status()
            Ok(response.json())
        } catch e: requests.Timeout {
            Err("Request timed out")
        } catch e: requests.HTTPError {
            Err("HTTP error: {e}")
        } catch e {
            Err("Unknown error: {e}")
        }
    }
    
    // Test with valid URL
    match fetch_safely("https://api.github.com") {
        Ok(data) => print("Success: received data"),
        Err(error) => print("Error: {error}")
    }
    
    // Test with invalid URL
    match fetch_safely("https://invalid.url.example") {
        Ok(data) => print("Success: {data}"),
        Err(error) => print("Error (expected): {error}")
    }
}

// ============ Main ============

fn main() {
    print("ðŸ¦‰ OwlLang Python Interoperability Demo\n")
    
    numpy_demo()
    pandas_demo()
    json_demo()
    data_analysis_pipeline()
    safe_python_call()
    
    // Uncomment for network demos (requires internet)
    // requests_demo()
    
    // Uncomment for plot demos (requires display or file output)
    // matplotlib_demo()
    
    print("\nâœ… All demos completed!")
}
